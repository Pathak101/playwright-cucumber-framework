trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

schedules:
  - cron: "0 1 * * *"   # üåô Nightly regression at 1 AM
    displayName: Nightly Regression
    branches:
      include:
        - main
    always: true

parameters:
  - name: TEST_TYPE
    displayName: Test Type
    type: string
    default: regression
    values:
      - smoke
      - regression

variables:
  IMAGE_NAME: pw-cucumber
  TEST_ENV: qa
  IS_PR: $[eq(variables['Build.Reason'], 'PullRequest')]

stages:
  - stage: Test
    displayName: Playwright Cucumber Tests
    jobs:
      - job: RunTests
        displayName: Run Tests in Docker
        pool:
          vmImage: ubuntu-latest

        steps:
          - checkout: self

          # üìà Restore Allure history (trend support)
          - task: DownloadPipelineArtifact@2
            displayName: Restore Allure History
            inputs:
              artifact: allure-history
              path: reports/allure-results/history
            continueOnError: true

          # üê≥ Build Docker image
          - task: Bash@3
            displayName: Build Docker Image
            inputs:
              targetType: inline
              script: |
                docker build -t $(IMAGE_NAME) .

          # ‚ñ∂Ô∏è Run tests
          - task: Bash@3
            displayName: Run Playwright Tests
            env:
              TEST_USER: $(TEST_USER)
              TEST_PASS: $(TEST_PASS)
            inputs:
              targetType: inline
              script: |
                if [ "$(IS_PR)" = "true" ]; then
                  echo "üîç PR build ‚Üí running SMOKE tests"
                  TAGS="@smoke"
                else
                  echo "üöÄ Main/Nightly build ‚Üí running ${{ parameters.TEST_TYPE }}"
                  if [ "${{ parameters.TEST_TYPE }}" = "smoke" ]; then
                    TAGS="@smoke"
                  else
                    TAGS=""
                  fi
                fi

                docker run --rm \
                  -e TEST_USER=$TEST_USER \
                  -e TEST_PASS=$TEST_PASS \
                  -e ENV=$(TEST_ENV) \
                  -e CUCUMBER_FILTER_TAGS="$TAGS" \
                  -v $(System.DefaultWorkingDirectory)/reports:/app/reports \
                  $(IMAGE_NAME)

          # üì¶ Publish Playwright traces
          - task: PublishPipelineArtifact@1
            displayName: Publish Playwright Traces
            inputs:
              targetPath: reports/traces
              artifact: playwright-traces
            condition: always()

          # üì¶ Publish Playwright videos
          - task: PublishPipelineArtifact@1
            displayName: Publish Playwright Videos
            inputs:
              targetPath: reports/videos
              artifact: playwright-videos
            condition: always()

          # üì¶ Publish Allure results
          - task: PublishPipelineArtifact@1
            displayName: Publish Allure Results
            inputs:
              targetPath: reports/allure-results
              artifact: allure-results
            condition: always()

          # üìà Save Allure history for next run
          - task: PublishPipelineArtifact@1
            displayName: Save Allure History
            inputs:
              targetPath: reports/allure-results/history
              artifact: allure-history
            condition: always()
